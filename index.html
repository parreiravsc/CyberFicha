<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ficha Cyberpunk - Savage Worlds</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto+Mono:wght@400;700&display=swap"
        rel="stylesheet">
    <style>
        /* Variáveis CSS para fácil ajuste de cores */
        :root {
            --bg-dark: #1a1a2e;
            --text-light: #e0e0e0;
            --accent-blue: #00bcd4;
            --accent-purple: #ff00ff;
            --accent-green: #00ff00;
            --border-dark: #333;
            --border-light: #555;
            --input-bg: #2d2d44;
            --hover-light: #007bff;
            --color-ok: #008000;
            --color-alert: #cccc00;
            --color-danger: #800000;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto Mono', monospace;
            margin: 0;
            background-color: var(--bg-dark);
            color: var(--text-light);
            line-height: 1.6;
            text-shadow: 0 0 2px var(--accent-blue);
        }

        /* Container principal com layout vertical */
        .sheet-container {
            max-width: 600px;
            margin: 20px auto;
            padding: 20px;
            background-color: #0d0d1a;
            border: 2px solid var(--accent-blue);
            box-shadow: 0 0 15px var(--accent-blue);
            display: flex;
            flex-direction: column;
            gap: 25px;
            position: relative;
            overflow: hidden;
        }

        /* Efeito de glitch sutil no fundo */
        .sheet-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image:
                repeating-linear-gradient(0deg, rgba(0, 255, 255, 0.05) 0px, rgba(0, 255, 255, 0.05) 1px, transparent 1px, transparent 10px),
                repeating-linear-gradient(90deg, rgba(255, 0, 255, 0.05) 0px, rgba(255, 0, 255, 0.05) 1px, transparent 1px, transparent 10px);
            opacity: 0.1;
            pointer-events: none;
            z-index: 0;
        }

        .header {
            text-align: center;
            border-bottom: 2px solid var(--accent-purple);
            padding-bottom: 10px;
            margin-bottom: 0;
            position: relative;
            z-index: 1;
        }

        h1,
        h2,
        h3 {
            font-family: 'Orbitron', sans-serif;
            text-align: center;
            color: var(--accent-green);
            border-bottom: 2px solid var(--accent-blue);
            padding-bottom: 8px;
            margin-top: 20px;
            margin-bottom: 15px;
            text-shadow: 0 0 5px var(--accent-green);
        }

        h1 {
            font-size: 2.2em;
            text-transform: uppercase;
        }

        h2 {
            font-size: 1.2em;
        }

        h3 {
            font-size: 1.0em;
        }

        .section {
            background-color: var(--input-bg);
            border: 1px solid var(--border-light);
            border-left: 3px solid var(--accent-blue);
            border-right: 3px solid var(--accent-purple);
            padding: 15px;
            border-radius: 2px;
            box-shadow: 0 0 8px rgba(0, 255, 255, 0.2), inset 0 0 5px rgba(255, 0, 255, 0.1);
            position: relative;
            z-index: 1;
        }

        .section::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            border: 1px dashed rgba(0, 255, 255, 0.1);
            pointer-events: none;
            z-index: -1;
        }

        label {
            display: block;
            margin-top: 10px;
            font-weight: bold;
            color: var(--accent-blue);
            text-transform: uppercase;
        }

        input[type="text"],
        input[type="number"],
        textarea,
        select {
            width: calc(100% - 10px);
            padding: 8px;
            border: 1px solid var(--accent-blue);
            background-color: #1a1a2e;
            color: var(--text-light);
            border-radius: 2px;
            margin-top: 5px;
            font-family: 'Roboto Mono', monospace;
            box-shadow: inset 0 0 3px rgba(0, 255, 255, 0.3);
            transition: border-color 0.3s, box-shadow 0.3s;
            font-size: 0.9em;
        }

        input:focus,
        textarea:focus,
        select:focus {
            border-color: var(--accent-green);
            box-shadow: inset 0 0 5px var(--accent-green), 0 0 5px var(--accent-green);
            outline: none;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .flex-row {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 10px;
        }

        .flex-row label {
            margin: 0;
            color: var(--accent-purple);
        }

        .flex-row input {
            width: auto;
            flex-grow: 0;
        }

        .xp-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .xp-group label {
            margin: 0;
            color: var(--accent-purple);
        }

        .xp-group input {
            width: 50px;
        }

        .dice-selector {
            display: flex;
            gap: 5px;
            justify-content: space-around;
            margin-top: 10px;
        }

        .dice-selector input[type="radio"] {
            display: none;
        }

        .dice-selector label {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 50px;
            height: 50px;
            border: 2px solid var(--border-light);
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: bold;
            background-color: var(--input-bg);
            color: var(--text-light);
            transition: all 0.2s;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.5);
        }

        .list-section .dice-selector label,
        .assistant-section .dice-selector label {
            width: auto;
            padding: 0 10px;
        }

        .dice-selector label:hover {
            background-color: #3f3f5a;
            border-color: var(--accent-blue);
            color: var(--accent-blue);
            box-shadow: inset 0 0 5px var(--accent-blue), 0 0 5px rgba(0, 255, 255, 0.3);
        }

        .dice-selector input[type="radio"]:checked+label {
            background-color: var(--accent-blue);
            color: black;
            border-color: var(--accent-green);
            box-shadow: 0 0 10px var(--accent-green), inset 0 0 8px rgba(0, 0, 0, 0.8);
            text-shadow: none;
        }

        .dice-selector input[type="radio"]:checked+label::before {
            content: '>';
            position: absolute;
            left: 5px;
            color: var(--accent-purple);
            font-size: 0.8em;
        }

        .list-item {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px;
            background-color: #26263a;
            border-left: 2px solid var(--accent-purple);
            border-radius: 3px;
            box-shadow: inset 0 0 3px rgba(255, 0, 255, 0.1);
        }

        .list-item input {
            flex-grow: 1;
            border: 1px dashed var(--accent-purple);
            background-color: #1a1a2e;
        }

        .list-item .bonus {
            width: 60px;
            text-align: center;
            color: var(--accent-green);
        }

        .list-item .weapon-info {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .weapon-info .flex-row input {
            flex-grow: 1;
        }

        .weapon-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            justify-content: flex-end;
            margin-top: 10px;
        }

        .mods-section {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px dashed var(--border-light);
        }

        .section-title {
            font-family: 'Orbitron', sans-serif;
            text-align: center;
            color: var(--accent-green);
            border-bottom: 1px solid var(--accent-blue);
            padding-bottom: 5px;
            margin-bottom: 10px;
            font-size: 0.9em;
        }


        .add-button,
        .remove-button {
            background-color: var(--accent-blue);
            color: black;
            border: none;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.9em;
            border-radius: 3px;
            text-transform: uppercase;
            font-weight: bold;
            box-shadow: 0 0 5px rgba(0, 255, 255, 0.5);
            transition: background-color 0.2s, box-shadow 0.2s;
        }

        .add-button:hover {
            background-color: var(--accent-green);
            box-shadow: 0 0 8px var(--accent-green);
        }

        .remove-button {
            background-color: #b30000;
            box-shadow: 0 0 5px rgba(255, 0, 0, 0.5);
        }

        .remove-button:hover {
            background-color: #ff0000;
            box-shadow: 0 0 8px rgba(255, 0, 0, 0.8);
        }

        .controls {
            display: flex;
            flex-direction: column;
            align-items: stretch;
            gap: 15px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 2px solid var(--accent-purple);
            position: relative;
            z-index: 1;
        }

        .controls button,
        .controls input[type="file"] {
            background-color: var(--accent-blue);
            color: black;
            border: none;
            padding: 12px 15px;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            text-transform: uppercase;
            font-weight: bold;
            font-family: 'Orbitron', sans-serif;
            box-shadow: 0 0 10px var(--accent-blue);
            transition: background-color 0.3s, box-shadow 0.3s;
        }

        .controls button:hover {
            background-color: var(--accent-green);
            box-shadow: 0 0 15px var(--accent-green);
        }

        .controls input[type="file"]:hover {
            background-color: var(--accent-purple);
            box-shadow: 0 0 10px var(--accent-purple);
        }

        .controls label {
            text-align: center;
            color: var(--text-light);
            font-family: 'Orbitron', sans-serif;
            margin-bottom: -10px;
        }

        .wounds-fatigue div {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px dashed var(--border-light);
        }

        .wounds-fatigue h3 {
            border-bottom: none;
            margin-top: 5px;
            margin-bottom: 5px;
            color: var(--accent-purple);
            font-size: 1.1em;
            text-shadow: 0 0 3px var(--accent-purple);
        }

        .wounds-fatigue input[type="radio"] {
            display: none;
        }

        .wounds-fatigue input[type="radio"]+label {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 35px;
            height: 35px;
            border: 2px solid var(--accent-blue);
            background-color: #1a1a2e;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s;
            margin-right: 10px;
            color: var(--accent-blue);
            font-weight: bold;
            font-size: 1.1em;
        }

        .wounds-fatigue input[type="checkbox"] {
            display: none;
        }

        .wounds-fatigue input[type="checkbox"]+label {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 35px;
            height: 35px;
            border: 2px solid var(--accent-blue);
            background-color: #1a1a2e;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s;
            margin-right: 10px;
            color: var(--accent-blue);
            font-weight: bold;
            font-size: 1.1em;
        }

        input[type="radio"]:checked+label,
        input[type="checkbox"]:checked+label {
            transform: scale(1.1);
        }

        /* Cores de status de combate */
        input[name="corpo"][value="-1"]:checked+label,
        input[name="mente"][value="-1"]:checked+label {
            background-color: var(--color-ok);
            border-color: var(--color-ok);
            box-shadow: 0 0 8px var(--color-ok);
            color: black;
        }

        input[name="corpo"][value="-2"]:checked+label,
        input[name="mente"][value="-2"]:checked+label {
            background-color: var(--color-alert);
            border-color: var(--color-alert);
            box-shadow: 0 0 8px var(--color-alert);
            color: black;
        }

        input[name="corpo"][value="-3"]:checked+label,
        input[name="mente"][value="-3"]:checked+label {
            background-color: var(--color-danger);
            border-color: var(--color-danger);
            box-shadow: 0 0 8px var(--color-danger);
            color: black;
        }

        /* Estilos para o Vigor calculado */
        input[name="vigor_calc"][value="-1"]:checked+label {
            background-color: var(--color-ok);
            border-color: var(--color-ok);
            box-shadow: 0 0 8px var(--color-ok);
            color: black;
        }

        input[name="vigor_calc"][value="-2"]:checked+label {
            background-color: var(--color-alert);
            border-color: var(--color-alert);
            box-shadow: 0 0 8px var(--color-alert);
            color: black;
        }

        input[name="vigor_calc"][value="-3"]:checked+label {
            background-color: var(--color-danger);
            border-color: var(--color-danger);
            box-shadow: 0 0 8px var(--color-danger);
            color: black;
        }

        /* Estilos para o Escudo Cibernético */
        .wounds-fatigue input[name="shield"] {
            display: none;
        }

        .wounds-fatigue input[name="shield"]+label {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 35px;
            height: 35px;
            border: 2px solid var(--accent-blue);
            background-color: transparent;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s;
            margin-right: 10px;
            color: var(--accent-blue);
            font-weight: bold;
            font-size: 1.1em;
        }

        .wounds-fatigue input[name="shield"]:checked+label {
            background-color: var(--accent-blue);
            color: black;
            border-color: var(--accent-green);
            box-shadow: 0 0 10px var(--accent-green), inset 0 0 8px rgba(0, 0, 0, 0.8);
            text-shadow: none;
            transform: scale(1.1);
        }

        /* Estilos para as abas */
        .tab-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab-button {
            flex-grow: 1;
            background-color: var(--input-bg);
            border: 2px solid var(--accent-blue);
            color: var(--accent-blue);
            padding: 10px 15px;
            font-family: 'Orbitron', sans-serif;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            box-shadow: 0 0 5px var(--accent-blue);
        }

        .tab-button.active {
            background-color: var(--accent-blue);
            color: black;
            border-color: var(--accent-green);
            box-shadow: 0 0 10px var(--accent-green);
            text-shadow: none;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
    </style>
</head>

<body>

    <div class="sheet-container">
        <div class="header">
            <h1>Ficha de Personagem</h1>
            <h3>Savage Worlds</h3>
        </div>

        <div class="tab-buttons">
            <button class="tab-button active" onclick="showTab('main-sheet', 'ficha_base.html', this)">Principal</button>
            <button class="tab-button" onclick="showTab('assistant-sheet', 'ficha_assistente.html', this)">Assistente</button>
        </div>
        <div class="tab-buttons">
            <button class="tab-button" onclick="showTab('armor-sheet', 'ficha_armadura.html', this)">Armadura</button>
            <button class="tab-button" onclick="showTab('weapons-sheet', 'ficha_armas.html', this)">Armas</button>
        </div>
        <div class="tab-buttons">
            <button class="tab-button" onclick="showTab('items-sheet', 'ficha_itens.html', this)">Itens</button>
        </div>

        <div id="main-sheet" class="tab-content active"></div>
        <div id="assistant-sheet" class="tab-content"></div>
        <div id="armor-sheet" class="tab-content"></div>
        <div id="weapons-sheet" class="tab-content"></div>
        <div id="items-sheet" class="tab-content"></div>

        <div class="controls">
            <button onclick="saveSheet()">Salvar Ficha .JSON</button>
            <label>Carregar Dados de Arquivo:</label>
            <input type="file" id="load-file" accept=".json">
            <button onclick="loadSheet()">Carregar Ficha</button>
        </div>
    </div>

    <script>
        let lastCheckedRadio = {};

        const dieTypes = ['d4', 'd6', 'd8', 'd10', 'd12'];
        const skillDieTypes = ['1d4-2', 'd4', 'd6', 'd8', 'd10', 'd12'];
        const attributes = ['agility', 'smarts', 'spirit', 'strength', 'charisma'];
        const dieValues = { '1d4-2': 0, 'd4': 2, 'd6': 3, 'd8': 4, 'd10': 5, 'd12': 6 };

        const baseSkills = [
            { name: 'Atletismo', attr: 'Agilidade' }, { name: 'Briga', attr: 'Físico' },
            { name: 'Armas Pesadas', attr: 'Físico' }, { name: 'Direção', attr: 'Agilidade' },
            { name: 'Atirar', attr: 'Agilidade' }, { name: 'Furtividade', attr: 'Agilidade' },
            { name: 'Ladroagem', attr: 'Agilidade' }, { name: 'Persuasão', attr: 'Carisma' },
            { name: 'Intimidação', attr: 'Carisma' }, { name: 'Enganação', attr: 'Carisma' },
            { name: 'Empatia', attr: 'Carisma' }, { name: 'Performance', attr: 'Carisma' },
            { name: 'Cibernética', attr: 'Astúcia' }, { name: 'Robótica', attr: 'Astúcia' },
            { name: 'Ciência', attr: 'Astúcia' }, { name: 'Medicina', attr: 'Astúcia' },
            { name: 'Investigar', attr: 'Astúcia' }, { name: 'Improvisar', attr: 'Espírito' },
            { name: 'Liderança', attr: 'Espírito' }, { name: 'Psiquismo', attr: 'Espírito' }
        ];

        const baseAssistantSkills = [
            { name: 'Programar' },
            { name: 'Interface' },
            { name: 'Percepção' }
        ];

        function getDieValue(dieString) {
            return dieValues[dieString] || 0;
        }

        function showTab(tabId, filePath, button) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            const tabContent = document.getElementById(tabId);
            tabContent.classList.add('active');
            button.classList.add('active');

            if (tabContent.innerHTML === "") {
                fetch(filePath)
                    .then(response => response.text())
                    .then(html => {
                        tabContent.innerHTML = html;
                        if (tabId === 'main-sheet') {
                            initializeMainSheet();
                        } else if (tabId === 'assistant-sheet') {
                            initializeAssistantSheet();
                        } else if (tabId === 'armor-sheet') {
                            initializeArmorSheet();
                        } else if (tabId === 'weapons-sheet') {
                            initializeWeaponsSheet();
                        } else if (tabId === 'items-sheet') {
                            initializeItemsSheet();
                        }
                    });
            }
        }

        function initializeMainSheet() {
            addAttributeSelectors();
            createInitialSkills();
            const inputs = document.querySelectorAll('#main-sheet input, #main-sheet textarea, #main-sheet select');
            inputs.forEach(input => {
                input.addEventListener('change', updateAllSheets);
                input.addEventListener('input', updateAllSheets);
            });
            updateAllSheets();
        }

        function initializeAssistantSheet() {
            addAssistantSelectors();
            createAssistantSkills();
            const inputs = document.querySelectorAll('#assistant-sheet input, #assistant-sheet textarea, #assistant-sheet select');
            inputs.forEach(input => {
                input.addEventListener('change', updateAllSheets);
                input.addEventListener('input', updateAllSheets);
            });
            updateAllSheets();
        }

        function initializeArmorSheet() {
            const inputs = document.querySelectorAll('#armor-sheet input, #armor-sheet textarea, #armor-sheet select');
            inputs.forEach(input => {
                input.addEventListener('change', updateAllSheets);
                input.addEventListener('input', updateAllSheets);
            });
            updateAllSheets();
        }

        function initializeWeaponsSheet() {
            const inputs = document.querySelectorAll('#weapons-sheet input, #weapons-sheet textarea, #weapons-sheet select');
            inputs.forEach(input => {
                input.addEventListener('change', updateAllSheets);
                input.addEventListener('input', updateAllSheets);
            });
            updateAllSheets();
        }

        function initializeItemsSheet() {
            const inputs = document.querySelectorAll('#items-sheet input, #items-sheet textarea, #items-sheet select');
            inputs.forEach(input => {
                input.addEventListener('change', updateAllSheets);
                input.addEventListener('input', updateAllSheets);
            });
            updateAllSheets();
        }

        function updateAllSheets() {
            updateCalculatedStats();
            updateAssistantStats();
            updateArmorStats();
        }


        function handleRadioClick(clickedRadio) {
            const radioName = clickedRadio.name;
            if (lastCheckedRadio[radioName] === clickedRadio) {
                clickedRadio.checked = false;
                lastCheckedRadio[radioName] = null;
            } else {
                lastCheckedRadio[radioName] = clickedRadio;
            }
            updateAllSheets();
        }

        function updateCalculatedStats() {
            const agilityDie = document.querySelector('input[name="attr-agility"]:checked')?.value || 'd4';
            const smartsDie = document.querySelector('input[name="attr-smarts"]:checked')?.value || 'd4';
            const spiritDie = document.querySelector('input[name="attr-spirit"]:checked')?.value || 'd4';
            const charismaDie = document.querySelector('input[name="attr-charisma"]:checked')?.value || 'd4';
            const fisDie = document.querySelector('input[name="attr-strength"]:checked')?.value || 'd4';
            const armorBonus = parseInt(document.getElementById('armor-bonus')?.value) || 0;
            const firewallBonus = parseInt(document.getElementById('firewall-bonus')?.value) || 0;
            const ciberneticoBonus = parseInt(document.getElementById('cibernetico-bonus')?.value) || 0;
            const velocidadeBonus = parseInt(document.getElementById('velocidade-bonus')?.value) || 0;
            const cargaBonus = parseInt(document.getElementById('carga-bonus')?.value) || 0;
            const vigorBonus = parseInt(document.getElementById('vigor-bonus')?.value) || 0;


            const baseFirewall = 2 + getDieValue(smartsDie);
            const totalFirewall = baseFirewall + firewallBonus;

            if (document.getElementById('stat-firewall')) {
                document.getElementById('stat-firewall').value = totalFirewall;
                document.getElementById('resist-resistencia').value = 2 + getDieValue(fisDie) + armorBonus;
                document.getElementById('resist-defesa').value = 2 + getDieValue(agilityDie);
                document.getElementById('resist-conviccao').value = 2 + getDieValue(charismaDie);
                document.getElementById('resist-percepcao').value = 2 + getDieValue(smartsDie);
                document.getElementById('resist-destino').value = 2 + getDieValue(spiritDie);

                const atletismoSkill = Array.from(document.querySelectorAll('#skills-list .list-item'))
                    .find(item => item.querySelector('[data-skill-name]').value === 'Atletismo');
                const atletismoDie = atletismoSkill?.querySelector('input[type="radio"]:checked')?.value || '1d4-2';

                document.getElementById('stat-cibernetico').value = getDieValue(fisDie) + getDieValue(spiritDie) + ciberneticoBonus;
                document.getElementById('stat-velocidade').value = getDieValue(fisDie) + getDieValue(atletismoDie) + velocidadeBonus;
                document.getElementById('stat-carga').value = 2 + getDieValue(fisDie) + cargaBonus;


                document.getElementById('power-max').value = 2 + getDieValue(spiritDie);
                document.getElementById('focus-max').value = 2 + getDieValue(fisDie);
                document.getElementById('ram-max').value = 2 + getDieValue(smartsDie);

                const corpoValue = parseInt(document.querySelector('input[name="corpo"]:checked')?.value || '0');
                const menteValue = parseInt(document.querySelector('input[name="mente"]:checked')?.value || '0');
                const vigorTotal = corpoValue + menteValue - vigorBonus;

                document.getElementById('vigor1').checked = vigorTotal <= -1;
                document.getElementById('vigor2').checked = vigorTotal <= -2;
                document.getElementById('vigor3').checked = vigorTotal <= -3;

                const recursosData = {
                    extravagante: parseInt(document.getElementById('recursos-extravagante').value) || 0,
                    rico: parseInt(document.getElementById('recursos-rico').value) || 0,
                    comum: parseInt(document.getElementById('recursos-comum').value) || 0,
                    modesto: parseInt(document.getElementById('recursos-modesto').value) || 0,
                    pobre: parseInt(document.getElementById('recursos-pobre').value) || 0,
                };

                let highestResourceName = '';

                if (recursosData.extravagante > 0) {
                    highestResourceName = 'Extravagante';
                } else if (recursosData.rico > 0) {
                    highestResourceName = 'Rico';
                } else if (recursosData.comum > 0) {
                    highestResourceName = 'Comum';
                } else if (recursosData.modesto > 0) {
                    highestResourceName = 'Modesto';
                } else if (recursosData.pobre > 0) {
                    highestResourceName = 'Pobre';
                } else {
                    highestResourceName = 'Nenhum';
                }
                document.getElementById('recursos-maior').value = highestResourceName;
            }
        }

        function updateAssistantStats() {
            const assistantType = document.getElementById('assistant-type')?.value;
            if (!assistantType) return;
            const firewallBonus = parseInt(document.getElementById('assistant-firewall-bonus')?.value) || 0;
            const processingBonus = parseInt(document.getElementById('assistant-processing-bonus')?.value) || 0;
            const ramMaxInput = document.getElementById('assistant-ram-max');

            let firewall = 5 + firewallBonus;
            let processing = 2 + processingBonus;

            if (assistantType === 'military') {
                ramMaxInput.removeAttribute('readonly');
                ramMaxInput.placeholder = "4 ou 5";
            } else if (assistantType === 'experimental') {
                ramMaxInput.removeAttribute('readonly');
                ramMaxInput.placeholder = "1 a 6";
            } else {
                ramMaxInput.setAttribute('readonly', true);
                ramMaxInput.value = 3;
                ramMaxInput.placeholder = "";
            }

            if (document.getElementById('assistant-firewall')) {
                document.getElementById('assistant-firewall').value = firewall;
                document.getElementById('assistant-processing').value = processing;
            }
        }

        function updateArmorStats() {
            const armorBase = parseInt(document.getElementById('armor-value-base')?.value) || 0;
            const modsBonus = Array.from(document.querySelectorAll('#armor-mods-list .mod-bonus')).reduce((sum, mod) => sum + (parseInt(mod.value) || 0), 0);
            const totalArmor = armorBase + modsBonus;

            if (document.getElementById('armor-total')) {
                document.getElementById('armor-total').value = totalArmor;
                const armorBonusInput = document.getElementById('armor-bonus');
                if (armorBonusInput) {
                    armorBonusInput.value = totalArmor;
                    updateCalculatedStats();
                }
            }
        }

        function addAttributeSelectors() {
            attributes.forEach(attr => {
                const container = document.querySelector(`.dice-selector[data-attr="${attr}"]`);
                if (!container) return;
                let html = '';
                dieTypes.forEach(die => {
                    const id = `attr-${attr}-${die}`;
                    html += `<input type="radio" id="${id}" name="attr-${attr}" value="${die}" onchange="updateAllSheets()">`;
                    html += `<label for="${id}">${die}</label>`;
                });
                container.innerHTML = html;
            });
        }

        function addAssistantSelectors() {
            const iceContainer = document.querySelector('.dice-selector[data-attr="ice-passivo"]');
            if (!iceContainer) return;
            let iceHtml = '';
            dieTypes.forEach(die => {
                const id = `assistant-ice-passivo-${die}`;
                iceHtml += `<input type="radio" id="${id}" name="assistant-ice-passivo" value="${die}" onchange="updateAllSheets()">`;
                iceHtml += `<label for="${id}">${die}</label>`;
            });
            iceContainer.innerHTML = iceHtml;
        }

        function createSkillItem(name, die = '1d4-2', bonus = '0', containerId) {
            const list = document.getElementById(containerId);
            if (!list) return;

            const itemDiv = document.createElement('div');
            itemDiv.className = 'list-item';

            const nameInput = document.createElement('input');
            nameInput.type = 'text';
            nameInput.placeholder = `Nome da Perícia`;
            nameInput.value = name;
            nameInput.dataset.skillName = name;

            const diceSelectorContainer = document.createElement('div');
            diceSelectorContainer.className = 'dice-selector';
            const skillId = `skill-${name.replace(/\s/g, '-')}`;
            skillDieTypes.forEach(d => {
                const id = `${skillId}-${d}`;
                const input = document.createElement('input');
                input.type = 'radio';
                input.id = id;
                input.name = skillId;
                input.value = d;
                input.onchange = updateAllSheets;
                const label = document.createElement('label');
                label.htmlFor = id;
                label.textContent = d;
                if (d === die) input.checked = true;
                diceSelectorContainer.appendChild(input);
                diceSelectorContainer.appendChild(label);
            });

            const bonusInput = document.createElement('input');
            bonusInput.type = 'number';
            bonusInput.className = 'bonus';
            bonusInput.placeholder = 'Bônus';
            bonusInput.value = bonus;

            itemDiv.appendChild(nameInput);
            itemDiv.appendChild(diceSelectorContainer);
            itemDiv.appendChild(bonusInput);
            list.appendChild(itemDiv);
        }

        function createInitialSkills() {
            const list = document.getElementById('skills-list');
            if (!list) return;
            list.innerHTML = '';
            baseSkills.forEach(skill => {
                createSkillItem(skill.name, '1d4-2', '0', 'skills-list');
            });
        }

        function createAssistantSkills() {
            const list = document.getElementById('assistant-skills-list');
            if (!list) return;
            list.innerHTML = '';
            baseAssistantSkills.forEach(skill => {
                createSkillItem(skill.name, 'd4', '0', 'assistant-skills-list');
            });
        }

        function addArmorMod(name = '', bonus = 0) {
            const list = document.getElementById('armor-mods-list');
            if (!list) return;
            const itemDiv = document.createElement('div');
            itemDiv.className = 'list-item';

            const nameInput = document.createElement('input');
            nameInput.type = 'text';
            nameInput.placeholder = 'Nome do Módulo';
            nameInput.value = name;

            const bonusInput = document.createElement('input');
            bonusInput.type = 'number';
            bonusInput.className = 'bonus mod-bonus';
            bonusInput.placeholder = 'Bônus';
            bonusInput.value = bonus;
            
            const removeButton = document.createElement('button');
            removeButton.className = 'remove-button';
            removeButton.textContent = 'X';
            removeButton.onclick = () => {
                list.removeChild(itemDiv);
                updateAllSheets();
            };

            itemDiv.appendChild(nameInput);
            itemDiv.appendChild(bonusInput);
            itemDiv.appendChild(removeButton);
            list.appendChild(itemDiv);
        }

        function addWeapon(name = '', damage = '', weight = '', value = '', notes = '', mods = [], quantity = 1) {
            const list = document.getElementById('weapons-list');
            if (!list) return;
            const weaponId = 'weapon-' + Date.now();

            const itemDiv = document.createElement('div');
            itemDiv.className = 'list-item';
            itemDiv.innerHTML = `
                <div class="weapon-info">
                    <input type="text" placeholder="Nome da Arma" value="${name}">
                    <div class="flex-row">
                        <label>Dano:</label>
                        <input type="text" placeholder="Ex: 2d6+1" style="width: 80px;" value="${damage}">
                        <label>Peso:</label>
                        <input type="text" placeholder="Kg" style="width: 50px;" value="${weight}">
                    </div>
                    <div class="flex-row">
                        <label>Valor:</label>
                        <input type="text" placeholder="cr" style="width: 60px;" value="${value}">
                        <label>Qtd:</label>
                        <input type="number" placeholder="1" style="width: 40px;" value="${quantity}">
                    </div>
                    <textarea placeholder="Notas sobre a arma..." style="min-height: 50px;" >${notes}</textarea>
                </div>
                <div class="weapon-controls">
                    <button class="add-button" onclick="toggleMods('${weaponId}')">Mods (+)</button>
                    <button class="remove-button" onclick="this.closest('.list-item').remove()">Remover</button>
                </div>
                <div id="${weaponId}" class="mods-section" style="display: none;">
                    <div class="section-title">Mods</div>
                    <div id="${weaponId}-mods-list"></div>
                    <button class="add-button" onclick="addWeaponMod('${weaponId}')">+ Novo Mod</button>
                </div>
            `;
            list.appendChild(itemDiv);

            mods.forEach(mod => addWeaponMod(weaponId, mod.name, mod.desc));
        }

        function toggleMods(weaponId) {
            const modsSection = document.getElementById(weaponId);
            const toggleButton = modsSection.previousElementSibling.querySelector('.add-button');
            if (modsSection.style.display === 'none') {
                modsSection.style.display = 'block';
                toggleButton.textContent = 'Mods (-)';
            } else {
                modsSection.style.display = 'none';
                toggleButton.textContent = 'Mods (+)';
            }
        }

        function addWeaponMod(weaponId, name = '', desc = '') {
            const list = document.getElementById(weaponId + '-mods-list');
            if (!list) return;
            const itemDiv = document.createElement('div');
            itemDiv.className = 'list-item';
            itemDiv.innerHTML = `
                <input type="text" placeholder="Nome do Mod" value="${name}">
                <input type="text" placeholder="Descrição do Mod" value="${desc}">
                <button class="remove-button" onclick="this.closest('.list-item').remove()">X</button>
            `;
            list.appendChild(itemDiv);
        }

        function addItem(type, name = '', desc = '', quantity = 1) {
            const list = document.getElementById(type + '-list');
            if (!list) return;
            const itemDiv = document.createElement('div');
            itemDiv.className = 'list-item';

            const quantityContainer = document.createElement('div');
            quantityContainer.style.display = 'flex';
            quantityContainer.style.alignItems = 'center';
            quantityContainer.style.gap = '5px';
            const quantityLabel = document.createElement('label');
            quantityLabel.textContent = 'Qtd:';
            quantityLabel.style.width = '30px';
            const quantityInput = document.createElement('input');
            quantityInput.type = 'number';
            quantityInput.className = 'item-quantity';
            quantityInput.style.width = '50px';
            quantityInput.value = quantity;
            quantityContainer.appendChild(quantityLabel);
            quantityContainer.appendChild(quantityInput);

            const nameInput = document.createElement('input');
            nameInput.type = 'text';
            if (type === 'items') {
                nameInput.placeholder = 'Nome do Item';
            } else if (type === 'edges') {
                nameInput.placeholder = 'Nome da Vantagem';
            } else if (type === 'hindrances') {
                nameInput.placeholder = 'Nome da Complicação';
            }
            nameInput.value = name;

            const descInput = document.createElement('input');
            descInput.type = 'text';
            descInput.placeholder = 'Descrição (opcional)';
            descInput.value = desc;

            const removeButton = document.createElement('button');
            removeButton.className = 'remove-button';
            removeButton.textContent = 'X';
            removeButton.onclick = () => list.removeChild(itemDiv);

            itemDiv.appendChild(quantityContainer);
            itemDiv.appendChild(nameInput);
            itemDiv.appendChild(descInput);

            if (type !== 'skills' && type !== 'assistant-skills') {
                itemDiv.appendChild(removeButton);
            }
            list.appendChild(itemDiv);
        }

        function saveSheet() {
            const armorMods = [];
            document.querySelectorAll('#armor-mods-list .list-item').forEach(item => {
                armorMods.push({
                    name: item.querySelector('input:nth-child(1)').value,
                    bonus: item.querySelector('input:nth-child(2)').value
                });
            });

            const weapons = [];
            document.querySelectorAll('#weapons-list > .list-item').forEach(weaponDiv => {
                const weaponId = weaponDiv.querySelector('.mods-section')?.id;
                const mods = [];
                if (weaponId) {
                    document.querySelectorAll(`#${weaponId}-mods-list .list-item`).forEach(modDiv => {
                        mods.push({
                            name: modDiv.querySelector('input:nth-child(1)').value,
                            desc: modDiv.querySelector('input:nth-child(2)').value
                        });
                    });
                }
                weapons.push({
                    name: weaponDiv.querySelector('.weapon-info input:nth-child(1)').value,
                    damage: weaponDiv.querySelector('.weapon-info .flex-row input:nth-child(2)').value,
                    weight: weaponDiv.querySelector('.weapon-info .flex-row input:nth-child(4)').value,
                    value: weaponDiv.querySelector('.weapon-info .flex-row input:nth-child(6)').value,
                    quantity: weaponDiv.querySelector('.weapon-info .flex-row input:nth-child(8)').value,
                    notes: weaponDiv.querySelector('.weapon-info textarea').value,
                    mods: mods
                });
            });
            const shieldStatus = Array.from(document.querySelectorAll('#main-sheet .shield-box')).map(box => box.checked);
            
            const itemLists = {};
            ['hindrances', 'edges', 'items'].forEach(type => {
                const list = [];
                document.querySelectorAll(`#${type}-list .list-item`).forEach(item => {
                    list.push({
                        name: item.querySelector('input[type="text"]:nth-child(2)').value,
                        desc: item.querySelector('input[type="text"]:nth-child(3)').value,
                        quantity: item.querySelector('.item-quantity')?.value || '1'
                    });
                });
                itemLists[type] = list;
            });

            const sheetData = {
                info: {
                    name: document.getElementById('char-name')?.value || '',
                    race: document.getElementById('char-race')?.value || '',
                    rank: document.getElementById('char-rank')?.value || '',
                    bene: document.getElementById('char-benes')?.value || '0',
                    xp: document.getElementById('char-xp')?.value || '0',
                    recursosExtravagante: document.getElementById('recursos-extravagante')?.value || '0',
                    recursosRico: document.getElementById('recursos-rico')?.value || '0',
                    recursosComum: document.getElementById('recursos-comum')?.value || '0',
                    recursosModesto: document.getElementById('recursos-modesto')?.value || '0',
                    recursosPobre: document.getElementById('recursos-pobre')?.value || '0',
                },
                attributes: {},
                derived: {
                    firewallBonus: document.getElementById('firewall-bonus')?.value || '0',
                    ciberneticoBonus: document.getElementById('cibernetico-bonus')?.value || '0',
                    velocidadeBonus: document.getElementById('velocidade-bonus')?.value || '0',
                    cargaBonus: document.getElementById('carga-bonus')?.value || '0',
                    armorBonus: document.getElementById('armor-bonus')?.value || '0',
                    vigorBonus: document.getElementById('vigor-bonus')?.value || '0',
                },
                conditions: {
                    corpo: document.querySelector('input[name="corpo"]:checked')?.value || '0',
                    mente: document.querySelector('input[name="mente"]:checked')?.value || '0',
                    shield: shieldStatus
                },
                resources: {
                    power: { current: document.getElementById('power-current')?.value || '0' },
                    focus: { current: document.getElementById('focus-current')?.value || '0' },
                    ram: { current: document.getElementById('ram-current')?.value || '0' },
                },
                lists: {
                    skills: [],
                    hindrances: itemLists.hindrances,
                    edges: itemLists.edges,
                    items: itemLists.items,
                },
                notes: document.getElementById('notes')?.value || '',
                assistant: {
                    name: document.getElementById('assistant-name')?.value || '',
                    type: document.getElementById('assistant-type')?.value || 'default',
                    firewallBonus: document.getElementById('assistant-firewall-bonus')?.value || '0',
                    processingBonus: document.getElementById('assistant-processing-bonus')?.value || '0',
                    icePassivo: document.querySelector('input[name="assistant-ice-passivo"]:checked')?.value || 'd4',
                    ramMax: document.getElementById('assistant-ram-max')?.value || '3',
                    ramCurrent: document.getElementById('assistant-ram-current')?.value || '0',
                    mods: {
                        mod1: document.getElementById('assistant-mod1')?.value || '',
                        mod2: document.getElementById('assistant-mod2')?.value || '',
                        mod3: document.getElementById('assistant-mod3')?.value || '',
                    },
                    nodes: document.getElementById('assistant-nodes')?.value || '',
                    skills: []
                },
                armor: {
                    name: document.getElementById('armor-name')?.value || '',
                    baseValue: document.getElementById('armor-value-base')?.value || '0',
                    mods: armorMods
                },
                weapons: weapons
            };

            attributes.forEach(attr => {
                const selectedDie = document.querySelector(`input[name="attr-${attr}"]:checked`);
                if (selectedDie) sheetData.attributes[attr] = selectedDie.value;
            });

            document.querySelectorAll('#skills-list .list-item').forEach(item => {
                const dieValue = item.querySelector('input[type="radio"]:checked')?.value || '1d4-2';
                sheetData.lists.skills.push({
                    name: item.querySelector('input[data-skill-name]').value,
                    die: dieValue,
                    bonus: item.querySelector('.bonus').value
                });
            });

            document.querySelectorAll('#assistant-skills-list .list-item').forEach(item => {
                const dieValue = item.querySelector('input[type="radio"]:checked')?.value || '1d4-2';
                sheetData.assistant.skills.push({
                    name: item.querySelector('input[data-skill-name]').value,
                    die: dieValue,
                    bonus: item.querySelector('.bonus').value
                });
            });

            const dataStr = JSON.stringify(sheetData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ficha_${sheetData.info.name || 'personagem'}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            alert('Ficha salva com sucesso! O arquivo foi baixado.');
        }

        function loadSheet() {
            const fileInput = document.getElementById('load-file');
            const file = fileInput.files[0];
            if (!file) {
                alert('Por favor, selecione um arquivo JSON para carregar.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function (event) {
                try {
                    const sheetData = JSON.parse(event.target.result);

                    document.getElementById('char-name').value = sheetData.info?.name || '';
                    document.getElementById('char-race').value = sheetData.info?.race || '';
                    document.getElementById('char-rank').value = sheetData.info?.rank || '';
                    document.getElementById('char-benes').value = sheetData.info?.bene || '0';
                    document.getElementById('char-xp').value = sheetData.info?.xp || '0';
                    document.getElementById('recursos-extravagante').value = sheetData.info?.recursosExtravagante || '0';
                    document.getElementById('recursos-rico').value = sheetData.info?.recursosRico || '0';
                    document.getElementById('recursos-comum').value = sheetData.info?.recursosComum || '0';
                    document.getElementById('recursos-modesto').value = sheetData.info?.recursosModesto || '0';
                    document.getElementById('recursos-pobre').value = sheetData.info?.recursosPobre || '0';

                    document.getElementById('armor-bonus').value = sheetData.derived?.armorBonus || '0';
                    document.getElementById('firewall-bonus').value = sheetData.derived?.firewallBonus || '0';
                    document.getElementById('cibernetico-bonus').value = sheetData.derived?.ciberneticoBonus || '0';
                    document.getElementById('velocidade-bonus').value = sheetData.derived?.velocidadeBonus || '0';
                    document.getElementById('carga-bonus').value = sheetData.derived?.cargaBonus || '0';
                    document.getElementById('vigor-bonus').value = sheetData.derived?.vigorBonus || '0';
                    document.getElementById('notes').value = sheetData.notes || '';

                    attributes.forEach(attr => {
                        const dieValue = sheetData.attributes?.[attr] || 'd4';
                        const radio = document.querySelector(`input[name="attr-${attr}"][value="${dieValue}"]`);
                        if (radio) radio.checked = true;
                    });
                    if (sheetData.conditions?.corpo) {
                        const radio = document.querySelector(`input[name="corpo"][value="${sheetData.conditions.corpo}"]`);
                        if (radio) radio.checked = true;
                    }
                    if (sheetData.conditions?.mente) {
                        const radio = document.querySelector(`input[name="mente"][value="${sheetData.conditions.mente}"]`);
                        if (radio) radio.checked = true;
                    }
                    if (sheetData.conditions?.shield) {
                        const shieldBoxes = document.querySelectorAll('#main-sheet .shield-box');
                        sheetData.conditions.shield.forEach((isChecked, index) => {
                            if (shieldBoxes[index]) {
                                shieldBoxes[index].checked = isChecked;
                            }
                        });
                    }

                    document.getElementById('power-current').value = sheetData.resources?.power?.current || '0';
                    document.getElementById('focus-current').value = sheetData.resources?.focus?.current || '0';
                    document.getElementById('ram-current').value = sheetData.resources?.ram?.current || '0';

                    const skillsList = document.getElementById('skills-list');
                    if (skillsList) {
                        skillsList.innerHTML = '';
                        (sheetData.lists?.skills || baseSkills).forEach(skill => {
                            createSkillItem(skill.name, skill.die, skill.bonus, 'skills-list');
                        });
                    }
                    document.getElementById('edges-list').innerHTML = '';
                    (sheetData.lists?.edges || []).forEach(edge => addItem('edges', edge.name, edge.desc));
                    document.getElementById('hindrances-list').innerHTML = '';
                    (sheetData.lists?.hindrances || []).forEach(hindrance => addItem('hindrances', hindrance.name, hindrance.desc));
                    document.getElementById('items-list').innerHTML = '';
                    (sheetData.lists?.items || []).forEach(item => addItem('items', item.name, item.desc, item.quantity));

                    if (sheetData.assistant) {
                        document.getElementById('assistant-name').value = sheetData.assistant?.name || '';
                        document.getElementById('assistant-type').value = sheetData.assistant?.type || 'default';
                        document.getElementById('assistant-firewall-bonus').value = sheetData.assistant?.firewallBonus || '0';
                        document.getElementById('assistant-processing-bonus').value = sheetData.assistant?.processingBonus || '0';
                        const iceDie = sheetData.assistant?.icePassivo || 'd4';
                        document.querySelector(`input[name="assistant-ice-passivo"][value="${iceDie}"]`).checked = true;
                        document.getElementById('assistant-ram-max').value = sheetData.assistant?.ramMax || '3';
                        document.getElementById('assistant-ram-current').value = sheetData.assistant?.ramCurrent || '0';
                        document.getElementById('assistant-mod1').value = sheetData.assistant?.mods?.mod1 || '';
                        document.getElementById('assistant-mod2').value = sheetData.assistant?.mods?.mod2 || '';
                        document.getElementById('assistant-mod3').value = sheetData.assistant?.mods?.mod3 || '';
                        document.getElementById('assistant-nodes').value = sheetData.assistant?.nodes || '';

                        const assistantSkillsList = document.getElementById('assistant-skills-list');
                        if (assistantSkillsList) {
                            assistantSkillsList.innerHTML = '';
                            (sheetData.assistant?.skills || baseAssistantSkills).forEach(skill => {
                                createSkillItem(skill.name, skill.die, skill.bonus, 'assistant-skills-list');
                            });
                        }
                    }

                    if (sheetData.armor) {
                        document.getElementById('armor-name').value = sheetData.armor.name || '';
                        document.getElementById('armor-value-base').value = sheetData.armor.baseValue || '0';
                        
                        const modsList = document.getElementById('armor-mods-list');
                        if (modsList) {
                            modsList.innerHTML = '';
                            (sheetData.armor.mods || []).forEach(mod => {
                                addArmorMod(mod.name, mod.bonus);
                            });
                        }
                    }
                    
                    const weaponsList = document.getElementById('weapons-list');
                    if (weaponsList) {
                        weaponsList.innerHTML = '';
                        (sheetData.weapons || []).forEach(weapon => {
                            addWeapon(weapon.name, weapon.damage, weapon.weight, weapon.value, weapon.notes, weapon.mods, weapon.quantity);
                        });
                    }

                    updateAllSheets();
                    alert('Ficha carregada com sucesso!');

                } catch (error) {
                    alert('Erro ao processar o arquivo. Certifique-se de que é um arquivo JSON válido.');
                    console.error('Erro ao carregar a ficha:', error);
                }
            };
            reader.readAsText(file);
        }

        window.onload = function () {
            showTab('main-sheet', 'ficha_base.html', document.querySelector('.tab-button'));
        };
    </script>
</body>

</html>